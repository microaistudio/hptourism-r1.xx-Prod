# HimKosh Integration - Single Source of Truth

## ⚠️ CRITICAL: This is the ONLY reference for HimKosh configuration

---

## Working .env Configuration

Copy these EXACTLY to your .env file:

```env
# HimKosh Payment Gateway - PRODUCTION CONFIG
HIMKOSH_MERCHANT_CODE=HIMKOSH230
HIMKOSH_DEPT_ID=230
HIMKOSH_SERVICE_CODE=TSM
HIMKOSH_DDO_CODE=CTO00-068
HIMKOSH_HEAD=1452-00-800-01
HIMKOSH_RETURN_URL=https://YOUR-DOMAIN/api/himkosh/callback
HIMKOSH_PAYMENT_URL=https://himkosh.hp.nic.in/echallan/WebPages/wrfApplicationRequest.aspx
HIMKOSH_KEY_FILE_PATH=/path/to/server/himkosh/echallan.key

# Test mode flags (set to false for production)
HIMKOSH_TEST_MODE=false
HIMKOSH_FORCE_TEST_MODE=false
```

---

## Key Values Explained

| Parameter | Value | Description |
|-----------|-------|-------------|
| MERCHANT_CODE | `HIMKOSH230` | HP Tourism merchant ID |
| DEPT_ID | `230` | Department 230 = Tourism |
| SERVICE_CODE | `TSM` | Tourism service code |
| DDO_CODE | `CTO00-068` | Chief Tourism Officer DDO |
| **HEAD** | `1452-00-800-01` | **Head of Account (CRITICAL!)** |

---

## DDO Codes by District

| District | DDO Code | Treasury |
|----------|----------|----------|
| Shimla | SML00-532 | SML |
| Kullu | KLU00-532 | KLU |
| Kangra | KNG00-532 | KGR |
| Mandi | MDI00-532 | MND |
| Chamba | CHM00-532 | CHB |
| Bilaspur | CHM00-532 | BLP |
| Kinnaur | KNR00-031 | KNR |
| Lahaul/Spiti | KZA00-011 | LSP |
| Hamirpur | HMR00-053 | HMP |
| Una | HMR00-053 | UNA |
| Sirmaur | SMR00-055 | SMR |
| Solan | SOL00-046 | SLN |

---

## Required Files

1. **echallan.key** - Encryption key from HimKosh team
   - Location: `server/himkosh/echallan.key`
   
2. **ddo_codes_seed.sql** - Database seed for DDO codes
   - Location: `Database/ddo_codes_seed.sql`

---

## Common Errors & Fixes

| Error | Cause | Fix |
|-------|-------|-----|
| "Amount Mismatch/Invalid Receipt Head" | Wrong HEAD code | Set `HIMKOSH_HEAD=1452-00-800-01` |
| "CTP-Transaction Rejected" | HEAD doesn't match DDO | Verify HEAD code is correct |
| "Amount ₹0" | Fee not calculated | Check application has `total_fee` set |

---

## Deployment Checklist

- [ ] Copy .env values above
- [ ] Update HIMKOSH_RETURN_URL to your domain
- [ ] Update HIMKOSH_KEY_FILE_PATH to correct path
- [ ] Run `npm run db:push` for schema
- [ ] Seed DDO codes: `psql -f Database/ddo_codes_seed.sql`
- [ ] Restart: `pm2 restart all`
